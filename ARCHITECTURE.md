# Архитектура системы управления логистикой

## Общая схема

```
┌─────────────────────────────────────────────────────────────┐
│                    Клиент (браузер)                          │
│  React SPA + Material-UI + Zustand + Recharts               │
└────────────────────────────┬────────────────────────────────┘
                             │ HTTP/HTTPS (REST API)
┌────────────────────────────▼────────────────────────────────┐
│                    Backend (Node.js + Express)              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Контроллеры: auth, planning-v2, financial-plan,     │  │
│  │  admin, email-schedules, smtp-config                 │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Сервисы: бизнес-логика, email, отчёты, планировщик  │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Модели TypeORM (PostgreSQL) + Redis (кеш, очереди)  │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────┘
                             │
         ┌───────────────────┼───────────────────┐
         │                   │                   │
┌────────▼────────┐ ┌───────▼───────┐ ┌─────────▼─────────┐
│   PostgreSQL    │ │     Redis     │ │   Внешние сервисы │
│  (логистические │ │  (кеш, очереди)│ │  (SMTP, SendGrid) │
│      данные)    │ │               │ │                   │
└─────────────────┘ └───────────────┘ └───────────────────┘
```

## Компоненты backend

### 1. Маршрутизация (Express Router)
- **auth.routes** – вход, восстановление пароля, регистрация (может быть отключена через `INVITE_ONLY=true`)
- **planning-v2.routes** – сегменты, значения, отчеты, экспорты
- **financial-plan.routes** – финплан и ставки НДС
- **admin.routes** – управление пользователями, аудит, системная статистика
- **email.routes** – расписания email‑рассылки
- **smtp-config.routes** – настройки SMTP
- **health endpoints** – `/health/*` (db/redis/scheduler)

### 2. Контроллеры
Каждый контроллер обрабатывает HTTP-запросы, делегируя бизнес-логику сервисам.

- **AuthController** – `login`, `register` (опционально), `forgotPassword`, `resetPassword`
- **PlanningV2Controller** – сегменты, значения, отчеты, итоги, экспорт
- **FinancialPlanController** – финплан, выгрузка Excel, ставки НДС
- **EmailScheduleController** – CRUD расписаний и тестовая отправка
- **SmtpConfigController** – настройки SMTP и тест подключения
- **AdminController** – `getUsers`, `inviteUser`, `updateUser`, `getAuditLog`, `getSystemStats`

### 3. Сервисы (бизнес-логика)
- **PlanningV2Service** – доступ и права по сегментам, работа с данными
- **PlanningV2ReportService** – расчеты дашбордов и отчетов
- **PlanningV2TotalsService** – годовые итоги и план с переносом
- **FinancialPlanService** – финплан и НДС
- **EmailService** – отправка писем через SMTP
- **EmailSchedulerService** – управление расписаниями отправки
- **ReportGenerationService** – формирование Excel/PDF (по необходимости)

### 4. Модели данных (TypeORM)
- **User** – пользователи системы (email, passwordHash, fullName, role)
- **PlanningSegment / PlanningMetric** – справочники планирования
- **PlanningDailyValue** – ежедневные значения
- **PlanningMonthlyPlan / PlanningMonthlyPlanMetric** – агрегаты по месяцу
- **FinancialPlanValue / FinancialVatRate** – финплан и НДС
- **EmailSchedule / SmtpConfig** – рассылки и SMTP
- **AppSetting / PlanHistory** – настройки приложения и история сохранений
- **AuditLog** – журнал действий

### 5. Middleware
- **authenticate** – проверка JWT-токена
- **authorize** – проверка ролей (admin, director, financer, manager_sales, manager_*)
- **express-validator** – валидация входящих данных
- **error‑handler** – централизованная обработка ошибок
- **logger** – структурированное логирование (Winston)

## Паспорт формул (Planning v2)

Ниже зафиксированы ключевые формулы, которые используются в backend и должны совпадать с Excel-логикой.

### 1) Базовые обозначения
- `daysInMonth` — количество дней в месяце.
- `completedDays` — завершенные дни: `day(asOfDate) - 1`.
- `planMonth` — месячный план (обычно `carryPlan`, если есть; иначе `basePlan`).
- `planToDate` — план на дату: `(planMonth / daysInMonth) * completedDays`.
- `factToDate` — сумма факта за дни `1..completedDays`.
- `monthFact` — сумма факта за весь месяц.

### 2) KTK (Владивосток/Москва)
- `Итого в день (план)` = `Выгрузка/погрузка (план)` + `Перемещение (план)`.
- `Итого в день (факт)` = `Выгрузка/погрузка (факт)` + `Перемещение (факт)`.
- `% на дату` = `factToDate / planToDate`.
- `% по месяцу` = `monthFact / planMonth`.
- `Среднее в день` = `factToDate / completedDays`.
- `Ср. вал сутки` = `grossToDate / completedDays`.

### 3) AUTO (Отправка авто)
- `waiting[d] = waiting[d-1] + received[d] - sent[d]`.
- `waiting[1] = waitingStart + received[1] - sent[1]`.
- `Итого принято` = сумма принятых по `Автовоз/КТК/Штора`.
- `Итого отправлено` = сумма отправленных по `Автовоз/КТК/Штора`.
- `Итого в ожидании` = сумма `waiting` по `Автовоз/КТК/Штора`.

### 4) RAIL
- `Из Владивостока (итого)` = `20` + `40`.
- `Во Владивосток (итого)` = `20` + `40`.
- `ЖД (итого)` = `Из Владивостока (итого)` + `Во Владивосток (итого)`.

### 5) EXTRA
- `Итог` = `Сборный груз` + `Шторы (тенты)` + `Экспедирование` + `Перетарка/доукрепление`.

### 6) План с переносом (Операционный отчет v2)
- Январь: `carry(1) = base(1)`.
- Для месяца `m > 1`:
  - `carry(m) = base(m) + max(0, carry(m-1) - fact(m-1))`.
- `% выполнения` = `fact / carry`.

### 7) Источник истины
- Все формулы считаются в backend (`planning-v2-report.service.ts`, `planning-v2-totals.service.ts`).
- Frontend только отображает данные и отправляет вводимые значения.

## Компоненты frontend

### 1. Структура приложения (React)
- **App.tsx** – корневой компонент с роутингом
- **layouts/DashboardLayout** – общий макет с боковым меню и шапкой
- **pages/** – страницы приложения:
  - `LoginPage` – страница входа
  - `PlansPage` – планирование по сегментам
  - `SummaryReportPage` – сводный отчёт
  - `AdminPage` – административная панель
  - `SettingsPage` – настройки (email, SMTP, НДС)
  - `ResetPasswordPage` – сброс пароля

### 2. Управление состоянием (Zustand)
- **auth‑store** – токен, данные пользователя, методы login/logout
- **data‑store** – кэшированные оперативные данные, планы
- **ui‑store** – состояние UI (тема, уведомления, загрузки)

### 3. Сервисы
- **api.ts** – Axios-инстанс с интерсепторами и обработкой 401/503
- **planning-v2.api.ts** – API планирования v2
- **financial-plan.api.ts** – API финплана

### 4. Компоненты
- **ExcelLikePlanTable** – Excel‑подобный ввод данных
- **PlanDashboard** – карточки ключевых показателей
- **YearTotalsV2Table** – итоги по году
- **DatePicker** – выбор даты (MUI X Date Pickers)
- **Notification** – уведомления (Snackbar)

## Финансовый результат (план)

- Для строки «Цена с НДС, руб/шт» в колонке «Итог за год» используется **среднее арифметическое** значений по месяцам.

## База данных

### PostgreSQL
- **Логическая схема** соответствует моделям TypeORM.
- **Индексы** на полях `segment`, `date`, `metric_type` для ускорения выборок.
- **Репликация** (в продакшене) для отказоустойчивости.

### Redis
- **Кеширование** часто запрашиваемых данных (например, месячные планы).
- **Очереди задач** (Bull) для фоновой генерации отчётов и отправки email.
- **Сессии** (опционально) – можно хранить сессионные данные.

## Взаимодействие с внешними системами

### SMTP-сервер
- Отправка приглашений пользователям.
- Рассылка ежедневных/итоговых отчётов.
- Используется Nodemailer с поддержкой TLS.

### Файловое хранилище
- Сгенерированные PDF/Excel файлы сохраняются в локальную папку `uploads` (в продакшене – S3‑совместимое хранилище).

### Мониторинг
- Логи приложения пишутся в файлы (`combined.log`, `error.log`) и выводятся в консоль.
- Метрики производительности можно собирать через Prometheus (не реализовано).

## Безопасность

- **Аутентификация** – JWT с сроком жизни 7 дней.
- **Авторизация** – ролевая модель (admin, director, financer, manager_sales, manager_*). Роль определяет доступ к сегменту/направлению, отдельного поля `department` у пользователя нет.
- **Регистрация** – по умолчанию закрыта (`INVITE_ONLY=true`), пользователи добавляются через админ‑приглашения.
- **Валидация** – все входящие данные проверяются на стороне сервера.
- **HTTPS** – обязателен в продакшене (через Nginx + Let's Encrypt).
- **Защита от инъекций** – TypeORM использует параметризованные запросы.
- **Лимиты запросов** – можно добавить `express‑rate‑limit` для защиты от DDoS.

## Масштабирование

### Вертикальное
- Увеличение ресурсов сервера (CPU, RAM) для обработки большего числа одновременных пользователей.

### Горизонтальное
- Запуск нескольких инстансов backend за балансировщиком нагрузки.
- Вынесение Redis в отдельный кластер.
- Использование managed PostgreSQL (например, AWS RDS).

### Оптимизация
- Кеширование тяжёлых отчётов в Redis.
- Пагинация данных в таблицах.
- Ленивая загрузка компонентов фронтенда.

## Резервное копирование и восстановление

1. **Ежедневный бэкап базы данных** через `pg_dump`.
2. **Резервное копирование файлов отчётов** (папка `uploads`).
3. **Хранение бэкапов** на удалённом хранилище (S3, FTP).
4. **План восстановления** документирован в отдельном runbook.

---

*Документ актуален на январь 2026 года.*
