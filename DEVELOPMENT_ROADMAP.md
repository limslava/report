# План дальнейшей разработки (Roadmap)

Документ фиксирует следующий этап развития проекта после текущей версии в продакшене.

## 1) Цели следующего этапа

- Довести расчеты и отчеты до полного совпадения с бизнес-логикой и Excel-эталоном.
- Повысить надежность продакшена (Redis, scheduler, ошибки 5xx, наблюдаемость).
- Закрыть UX-доработки для ежедневной работы менеджеров.
- Подготовить процесс безопасных релизов и поддержки.

## 2) Приоритеты (по порядку)

1. **Критическая стабильность продакшена**
2. **Корректность расчетов и отчетов**
3. **Регламент и удобство ежедневной эксплуатации**
4. **Техдолг, тесты и масштабирование**

---

## Этап A — Стабилизация продакшена (1–3 дня)

### A1. Redis и scheduler
- Проверить соединение с Redis в Amvera (host/port/password, таймауты, retries).
- Добавить явный health-check Redis и понятный статус scheduler в логах/эндпоинтах.
- Убедиться, что при недоступности Redis backend не падает, а корректно деградирует.

**Критерий приемки**
- Нет падений приложения из-за Redis.
- Рассылки по расписанию стабильно выполняются.
- В логах есть явные сообщения `scheduler started/stopped/error`.

### A2. Ошибки 502/5xx
- Локализовать проблемные запросы (особенно массовые сохранения и редактирование планов).
- Добавить ограничение частоты/дебаунс на клиенте там, где создаются “серии” запросов.
- Добавить защиту от race conditions в API сохранения.

**Критерий приемки**
- При обычной работе в UI нет 502.
- Серии быстрых правок не приводят к неконсистентным данным.

---

## Этап B — Полная корректность бизнес-логики (2–4 дня)

### B1. План с переносом (единая логика)
- Применить и проверить логику во всех направлениях:
  - `carry_m = base_m + debt_prev`
  - `debt_prev = max(0, carry_m - fact_m)`
  - перевыполнение не дает “кредит в минус”.
- Для строки “Итог за год / План с переносом” оставить значение как у базового годового плана (по согласованному правилу отображения).

**Критерий приемки**
- Совпадение с тест-кейсами по ТО/КТК/Авто/ЖД.
- Дашборды и ИТОГО не расходятся по `planMonth`.

### B2. AUTO (ожидание)
- Зафиксировать правило:
  - дневные ячейки ожидания — накопительные,
  - колонка “ИТОГО” для ожидания — **последнее значение месяца**, а не сумма.
- Проверить перенос остатков между месяцами и на границе года (декабрь -> январь).

**Критерий приемки**
- Для AUTO значения “В ожидании” в ИТОГО всегда соответствуют последнему дню периода.

### B3. Сводный отчет
- Проверить агрегирование подсегментов:
  - Автовозы/Шторы объединенно,
  - Авто в КТК отдельно,
  - ЖД объединенно “Из/Во Владивосток” согласно согласованной схеме.

**Критерий приемки**
- Сводный отчет совпадает с ИТОГО и дашбордами по тем же периодам.

---

## Этап C — UX и операционная удобность (2–3 дня)

### C1. Ежедневный отчет
- Финальный визуал дашбордов (единый размер карточек, выравнивание).
- Явная подсветка вычисляемых строк + блокировка редактирования.
- Единообразные русские тексты ошибок/подсказок.

### C2. Предупреждения о несохраненных данных
- Проверить все переходы: вкладки, левое меню, смена месяца/года, маршруты.
- Проверить корректные сценарии “Сохранить / Не сохранять”.

### C3. Email-шаблоны
- Унифицировать темы и тело писем для:
  - отчетов по направлениям,
  - СВ-отчета.
- Проверить русскую локализацию и формат дат `dd.mm.yyyy`.

**Критерий приемки**
- Бизнес-пользователь получает понятные письма с корректными вложениями и темами.

---

## Этап D — Качество, поддержка и релизы (2–5 дней)

### D1. Тесты
- Расширить unit-тесты:
  - перенос плана (в т.ч. перевыполнение),
  - AUTO waiting,
  - сводные агрегаты.
- Добавить smoke-checklist для ручной регрессии.

### D2. Техдолг
- Удалить/архивировать устаревшие части legacy-функционала (где подтверждено, что не используются).
- Привести названия ролей/экранов/метрик к единому словарю.

### D3. Релизный процесс
- Релиз через `main` + короткий changelog.
- Мини-чеклист перед каждым прод-деплоем:
  - миграции,
  - переменные окружения,
  - здоровье Redis/DB,
  - тестовая рассылка.

**Критерий приемки**
- Прогнозируемый деплой без “сюрпризов”.
- Понятная процедура отката.

---

## 3) Риски и меры

- **Риск:** рассинхрон между Excel-логикой и реализацией.  
  **Мера:** фиксированный набор эталонных тест-кейсов (янв/фев/март).

- **Риск:** Redis-сбои в managed-среде.  
  **Мера:** graceful degradation + мониторинг + отдельный health-check.

- **Риск:** “тихие” ошибки при массовом редактировании.  
  **Мера:** идемпотентные API, дебаунс, логирование входных батчей.

---

## 4) План работ на ближайшие 7 дней

- **День 1:** Redis/scheduler стабильность, логи, health-check.
- **День 2:** carry/waiting сверка на реальных данных прода.
- **День 3:** сводный отчет + дашборды (финальная формульная синхронизация).
- **День 4:** UX-полировка ежедневного отчета.
- **День 5:** email-шаблоны + расписания + финальная проверка.
- **День 6:** тесты и регрессия.
- **День 7:** релиз, мониторинг, bugfix-окно.

---

## 5) Definition of Done (DoD)

- Все ключевые формулы подтверждены на эталонных кейсах.
- Дашборды, ИТОГО и сводный показывают согласованные цифры.
- Рассылки стабильны и предсказуемы.
- Нет критичных 5xx в типовых сценариях.
- Обновлен changelog/документация по релизу.

