# План миграции направлений и ролей

## Цель
Объединить поля `department` и `role` в одно поле `role` с 8 возможными значениями, упростив модель доступа.

## Новые значения ролей
1. `container_vladivostok` – Контейнеры - Владивосток
2. `container_moscow` – Контейнеры - Москва
3. `autotruck` – ТС (ранее Автовозы)
4. `additional` – Доп. услуги
5. `railway` – ЖД перевозки
6. `sales` – Продажи (новая роль, заглушка)
7. `director` – Директор (новая роль, заглушка)
8. `admin` – Администратор

## Правила преобразования существующих данных
| Старая роль   | Старый department     | Новая роль          | Примечание                         |
|---------------|----------------------|---------------------|-----------------------------------|
| operator      | container_vladivostok | container_vladivostok |                                   |
| operator      | container_moscow     | container_moscow    |                                   |
| operator      | autotruck            | autotruck           |                                   |
| operator      | additional           | additional          |                                   |
| operator      | railway              | railway             |                                   |
| manager       | *                    | director            | Все менеджеры становятся директорами |
| admin         | *                    | admin               | Оставить без изменений            |

## Политика доступа
- **admin** и **director** – полный доступ ко всем данным (все направления).
- **sales** – доступ ко всем данным (предположительно, для анализа продаж).
- **Роли‑направления** (`container_vladivostok`, `container_moscow`, `autotruck`, `additional`, `railway`) – доступ только к данным своего направления (чтение/запись).

## Этапы реализации

### 1. Изменение модели User (`backend/src/models/user.model.ts`)
- Удалить поле `department` из TypeScript‑интерфейса и сущности TypeORM.
- Изменить поле `role` с типа `enum('operator','manager','admin')` на новый enum с 8 значениями.
- Обновить DTO (`CreateUserDto`, `UpdateUserDto`).

### 2. Миграция базы данных
- Создать SQL‑миграцию (`backend/database/migrations/YYYYMMDD_merge_role_department.sql`):
  ```sql
  ALTER TABLE users 
    DROP COLUMN department,
    ALTER COLUMN role TYPE VARCHAR(50);
  -- Затем обновить значения role согласно правилам преобразования
  ```
- Либо использовать TypeORM migrations (если подключены).

### 3. Обновление сидов (`backend/database/init/02-seed.sql`)
- Привести сиды в соответствие с новыми ролями.

### 4. Middleware авторизации (`backend/src/middleware/authorize.ts`)
- Переписать `authorizeDepartment` (переименовать в `authorizeRole`).
- Логика:
  - Если `user.role` – направление, разрешить доступ только к соответствующему `department` в параметре маршрута.
  - Если `user.role` ∈ {`admin`, `director`, `sales`}, разрешить доступ к любому `department`.

### 5. Фронтенд: замена `department` на `role`
- Во всех компонентах заменить `user.department` на `user.role`.
- Обновить `DashboardLayout.tsx`: фильтрация направлений должна учитывать новые правила (роли‑направления видят только свой блок).
- Обновить `DashboardPage.tsx`: отображать статистику только по доступным направлениям.
- Обновить `DepartmentPage.tsx`: использовать `role` вместо `department` для запроса данных.

### 6. Интерфейс администратора (`AdminPage.tsx`)
- В форме добавления/редактирования пользователя заменить выпадающий список направлений на выпадающий список новых ролей.
- Убрать поле «Направление».

### 7. Email‑сервис и шаблоны
- В шаблоне пригласительного письма вместо «Направление: {department}» выводить «Роль: {role}».

### 8. Модули оперативных данных и отчетов
- Во всех запросах, где используется `department` как параметр, оставить как есть (параметр означает направление данных, а не роль пользователя).
- Проверить, что расчётные формулы и агрегации не зависят от поля `department` в таблице `users`.

### 9. Тестирование
- Проверить вход под каждой ролью.
- Убедиться, что пользователь видит только разрешённые данные.
- Проверить отправку приглашений с новыми ролями.

### 10. Документация
- Обновить `ARCHITECTURE.md` (раздел «Роли и доступ»).
- Обновить комментарии в коде.

## Риски
- Существующие интеграции, ожидающие старые значения `role`/`department`, могут сломаться.
- Необходимо обновить все тестовые данные (включае демо‑аккаунты).

## Резервное копирование
Перед миграцией обязательно создать дамп базы данных.

## Оценка времени
~4–6 часов разработки и тестирования.